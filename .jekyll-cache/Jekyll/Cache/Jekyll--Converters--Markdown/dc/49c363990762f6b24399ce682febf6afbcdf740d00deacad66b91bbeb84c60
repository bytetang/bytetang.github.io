I"Z<p>Androidå·¥ç¨‹ç»„ä»¶åŒ–ä¹‹åä¸šåŠ¡å’Œç»„ä»¶éƒ½æ¯”è¾ƒç‹¬ç«‹ã€‚é™æ€åº“å‡çº§ä»¥åŠé›†æˆæ‰“åŒ…å·¥ä½œä¼šåˆ†æ•£åˆ°ä¸åŒèŒè´£æ‰€åœ¨çš„åŒå­¦ï¼Œæ¨¡å—å‘å¸ƒæµ‹è¯•æµç¨‹æ¶‰åŠåˆ°çš„å¯èƒ½ä¸æ­¢æ˜¯å¼€å‘çš„åŒå­¦ï¼Œä¹ŸåŒ…æ‹¬æµ‹è¯•ã€‚æœ¬æ–‡ä»‹ç»å¦‚ä½•å€ŸåŠ©Jenkinså·¥å…·å’ŒDjango webå¹³å°å®Œæˆè‡ªåŠ¨åŒ–å·¥ç¨‹æ„å»ºã€‚</p>

<blockquote>
  <p>æ–‡ç« å†…å®¹æœ‰é™ï¼Œæ›´å¤šæ˜¯æä¾›æ€è·¯ï¼Œæ¶‰åŠè¦æœ‰äº›æŠ€æœ¯ç»†èŠ‚ä¸åšç»†è‡´æè¿°ã€‚å…·ä½“çš„å¯ä»¥å›å¤æˆ–è€…ç§ä¿¡æ²Ÿé€šã€‚</p>
</blockquote>

<p>éœ€è¦è§£å†³çš„é—®é¢˜åˆ—ä¸¾å¦‚ä¸‹ï¼š</p>
<ul>
  <li>Libraryå·¥ç¨‹æ¨¡å—èƒ½å¤Ÿå¿«é€Ÿã€ä¾¿æ·æä¾›é™æ€åŒ…ã€‚</li>
  <li>Bundleä»¥åŠé™æ€åº“ç‰ˆæœ¬çš„ç®¡ç†ã€‚</li>
  <li>è‡ªåŠ¨åŒ–çš„æ¨¡å—é›†æˆã€‚</li>
  <li>å¯è§†åŒ–çš„æ“ä½œå¹³å°ã€‚</li>
</ul>

<p><br />
<br /></p>
<h1>ä½¿ç”¨mavenä»“åº“ç®¡ç†é™æ€</h1>

<p>gradleæ”¯æŒé™æ€çš„ç®¡ç†æ–¹å¼æœ‰å¤šç§æ–¹å¼ã€‚</p>
<h2>æ–¹å¼ä¸€ï¼šLocalæœ¬åœ°ç®¡ç†</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">repositories</span> <span class="o">{</span>
    <span class="n">flatDir</span> <span class="o">{</span>
        <span class="n">dirs</span> <span class="err">'</span><span class="n">libs</span><span class="err">'</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ¬åœ°ä¾èµ–å¯ä»¥åœ¨ç¦»çº¿çŠ¶æ€ä¸‹å·¥ä½œï¼Œå¼Šç«¯å°±æ˜¯é™æ€åº“çš„ç›®å½•éœ€è¦è·Ÿéšgitå»å‘å¸ƒã€‚å›ºå®šç‰ˆæœ¬çš„ä¾èµ–è¿˜éœ€è¦é€šçŸ¥æ›´æ–°ã€‚</p>

<h2>æ–¹å¼äºŒ:Mavenä»“åº“ç®¡ç†</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">maven</span> <span class="o">{</span>
     <span class="n">url</span> <span class="err">'</span><span class="o">***/</span><span class="n">repo</span><span class="o">/</span><span class="err">'</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸­å¤®ä»“åº“é€šå¸¸å¯ä»¥downloadå¸¸ç”¨çš„å„ç‰ˆæœ¬ä¾èµ–åº“ã€‚googleçš„æŸäº›åº“ç”šè‡³éœ€è¦ç¿»å¢™ï¼Œä¼ä¸šå»ºè®®æ­å»ºè‡ªå·±çš„nexusä»“åº“ï¼Œç”¨äºç®¡ç†è‡ªå·±çš„æ—¥å¸¸é™æ€åº“å‘å¸ƒã€‚
nexusçš„æ­å»ºç½‘ä¸Šæ¯”è¾ƒå¤šä¸åšè¯¦è¿°ã€‚</p>

<p>é‚£ä¹ˆAndroidè¯¥å¦‚ä½•ä¸Šä¼ è‡ªå·±çš„é™æ€åº“ï¼š</p>

<p>gradleå®˜æ–¹æœ‰uploadæ’ä»¶å’Œè¯¦ç»†çš„æ•™ç¨‹ï¼Œè¿™é‡Œè´´ä¸Šæœ€ä½³å®è·µï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">module</span> <span class="n">build</span><span class="o">.</span><span class="na">gradle</span>
<span class="n">apply</span> <span class="nl">plugin:</span> <span class="err">'</span><span class="n">maven</span><span class="err">'</span>
<span class="n">uploadArchives</span> <span class="o">{</span>
   <span class="n">repositories</span><span class="o">.</span><span class="na">mavenDeployer</span> <span class="o">{</span>
           <span class="n">repository</span><span class="o">(</span><span class="nl">url:</span><span class="s">"${project.ext.uploadRepo}"</span><span class="o">)</span> <span class="o">{</span>
               <span class="cm">/* nexus mavenæƒé™ç”¨æˆ·åå¯†ç  */</span>
               <span class="n">authentication</span><span class="o">(</span><span class="nl">userName:</span> <span class="s">""</span><span class="o">,</span> <span class="nl">password:</span> <span class="s">""</span><span class="o">)</span>  
               <span class="n">pom</span><span class="o">.</span><span class="na">groupId</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">groupId</span>
               <span class="n">pom</span><span class="o">.</span><span class="na">artifactId</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">artifactId</span>
               <span class="n">pom</span><span class="o">.</span><span class="na">version</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">ext</span><span class="o">.</span><span class="na">versionName</span>
           <span class="o">}</span>
       <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>é…ç½®ä¸Šä¼ çš„ä¿¡æ¯åˆ°moduleçš„build.gradleæ–‡ä»¶</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">project</span><span class="o">.</span><span class="na">ext</span> <span class="o">{</span>
   <span class="n">groupId</span> <span class="o">=</span> <span class="s">"com.test"</span> 
   <span class="n">versionName</span> <span class="o">=</span> <span class="s">"1.0.0"</span>
   <span class="n">artifactId</span> <span class="o">=</span> <span class="s">"android-common"</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿›å…¥é¡¹ç›®æ ¹è·¯å¾„,module_nameä¸ºéœ€è¦å‘å¸ƒé™æ€åº“library moduleçš„åç§°,æ‰§è¡Œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="o">./</span><span class="n">gradlew</span> <span class="o">:</span><span class="nl">module_name:</span><span class="n">uploadArchives</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>dependencyä¾èµ–æ–¹å¼ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">compile</span> <span class="err">'</span><span class="n">com</span><span class="o">.</span><span class="na">ctrip</span><span class="o">:</span><span class="n">android</span><span class="o">-</span><span class="nl">common:</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">0</span><span class="nd">@aar</span><span class="err">'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä»¥ä¸Šå¯ä»¥å®Œæˆé™æ€åº“å‘å¸ƒ/å‡çº§åˆ°mavenä»“åº“çš„æµç¨‹ã€‚ä¾èµ–çš„å‘å¸ƒå’Œå‡çº§ç®¡ç†ç®¡ç†å·²ç»æ–¹ä¾¿äº†å¾ˆå¤šï¼Œä¸è¿‡åªèƒ½å¼€å‘åœ¨æœ¬åœ°è¿è¡Œè„šæœ¬æ¥å®Œæˆï¼Œç‰ˆæœ¬å·çš„æ›´æ–°ä¾ç„¶éœ€è¦é€šè¿‡ä¿®æ”¹build.gradleä¸­çš„extç‰ˆæœ¬æäº¤æ‰è¡Œã€‚å‘å¸ƒçš„æµç¨‹æ¯”è¾ƒç¹çè€Œä¸”å®¹æ˜“å¯¼è‡´å†²çªã€‚</p>

<p>ä»¥ä¸Šï¼Œå¯ä»¥è¿›ä¸€æ­¥çš„è‡ªåŠ¨åŒ–ã€‚</p>

<h1>Jenkins æŒç»­é›†æˆ</h1>

<p>Jenkinä¸“æ³¨ciï¼Œè¢«å¹¿æ³›çš„åº”ç”¨åœ¨javaå’Œandroidçš„æŒç»­é›†æˆåº”ç”¨æ–¹é¢ã€‚Jenkins jobçš„è®¾è®¡å’Œä¸°å¯Œçš„pluginè®©æˆ‘ä»¬å¯ä»¥ä¸ç”¨è¿‡å¤šç¹æ‚çš„åŠŸèƒ½ç¼–ç å’Œéƒ¨ç½²ã€‚è¿™é‡Œé‡ç‚¹åº”ç”¨åˆ°å…¶ä¸­Jobï¼ˆpipline/freestyle jobï¼‰ã€Webhookã€SCMï¼ˆç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼‰çš„ç‰¹æ€§ã€‚</p>

<h3>ç›®æ ‡</h3>

<p>éæœ¬åœ°æ‰“åŒ…ä¸Šä¼ é™æ€åº“,è®©jenkinsè‡ªåŠ¨å®Œæˆæ‰“åŒ…ã€ä¸Šä¼ ä»¥åŠç‰ˆæœ¬æ§åˆ¶ã€‚</p>

<h3>æ­¥éª¤</h3>

<p><img src="/assets/images/jekins_step.png" alt="index page" /></p>

<h3>Job ç±»å‹</h3>

<p>Jenkinsæ”¯æŒå¤šç§ç±»å‹çš„jobï¼Œå…¶ä¸­å¸¸ç”¨çš„æ˜¯Freestyle projectã€maven projectã€piplineã€‚freestyleå¯ä»¥å®šåˆ¶ç¨‹åº¦æ¯”è¾ƒé«˜ï¼Œé»˜è®¤é›†æˆäº†SCMå·¥å…·ï¼Œèƒ½å¤Ÿæ”¯æŒå¤§å¤šæ•°å¸¸ç”¨çš„æ„å»ºè„šæœ¬è¯­è¨€ã€‚maven project ä¸€èˆ¬åº”ç”¨åœ¨mavenæ„å»ºçš„å·¥ç¨‹ã€‚piplineæœ‰æ¯”è¾ƒç›´è§‚çš„æ­¥éª¤å’Œæ—¥å¿—é¢„è§ˆï¼Œè¾ƒä¹‹äºfreestyleç±»å‹çš„jobåªèƒ½æ”¯æŒgroovyçš„è¯­æ³•ä¸”ä¸èƒ½ç›´æ¥åœ¨å¹³å°ä¸Šé¢„è§ˆworkspaceå†…å®¹ã€‚androidå·¥ç¨‹ç”±gradleæ„å»ºå·¥å…·æ¥è´Ÿè´£æ‰“åŒ…ï¼Œä¸ºäº†æ›´ç›´è§‚çš„æ•ˆæœä½¿ç”¨piplineä¹Ÿæ˜¯å¯ä»¥æ»¡è¶³éœ€æ±‚çš„ã€‚</p>

<h3>Download git source</h3>

<p>éœ€è¦æ„å»ºçš„å·¥ç¨‹æ¯æ¬¡éœ€è¦ä»gitä»“åº“æ‹‰å–ï¼Œå†ä»æœ¬åœ°workspaceç›´æ¥æ„å»ºç”Ÿæˆäº§ç‰©ã€‚é€‰æ‹©freelinestyle jobå¯ä»¥ç›´æ¥é€šè¿‡Source Code Management é€‰é¡¹é…ç½®ä¸‹Git url å’Œbranchã€‚å¯åŠ¨jobçš„æ—¶å€™ä¼šè‡ªåŠ¨æ ¹æ®é…ç½®ä¸‹è½½å·¥ç¨‹ä»£ç åˆ°workspaceã€‚å¦‚æœæ˜¯pipline jobç±»å‹ï¼Œæ— æ³•ä½¿ç”¨SCMï¼Œå¯ä»¥é€šè¿‡ä¹¦å†™pipline scriptï¼ˆgroovyï¼‰æ¥å®Œæˆã€‚</p>

<p>æ–¹å¼:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">node</span> <span class="o">{</span>
   <span class="n">stage</span><span class="o">(</span><span class="err">'</span><span class="nc">Preparation</span><span class="err">'</span><span class="o">)</span> <span class="o">{</span> 
     <span class="cm">/* ssh get build script repositoryï¼Œssh-urlå¡«å……ä½ çš„git url */</span>
     <span class="n">git</span> <span class="nl">url:</span><span class="err">'</span><span class="n">git</span><span class="nd">@ssh</span><span class="o">-</span><span class="n">url</span><span class="err">'</span><span class="o">,</span><span class="nl">branch:</span><span class="err">'</span><span class="n">master</span><span class="err">'</span>
   <span class="o">}</span>
<span class="o">...</span> <span class="n">æ­¤å¤„çœç•¥å…¶ä»–stage</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3>æ„å»º</h3>

<p>build-scripté‡Œé¢åŒ…å«äº†æ‰“åŒ…å’Œä¸Šä¼ çš„è„šæœ¬ã€‚</p>

<p>ç¼–è¯‘/æ‰“åŒ…moduleæ ¸å¿ƒï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="o">./</span><span class="n">gradlew</span> <span class="n">clean</span> <span class="n">assembleRelease</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<h3>ä¸Šä¼ </h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="o">./</span><span class="n">gradlew</span> <span class="o">:</span><span class="nl">module_name:</span><span class="n">uploadArchives</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ¬äººå–„ç”¨pythonï¼Œè€Œä¸”é€‚ç”¨Linux/windows/macosä»»ä½•å¹³å°ã€‚ç¼–è¯‘å’Œä¸Šä¼ çš„æ­¥éª¤è¿™é‡Œå‡è®¾åŒ…è£…åˆ°android_bundle_build.pyæ–‡ä»¶é‡Œã€‚è¿™é‡Œå»ºè®®æŠŠè„šæœ¬ä¹Ÿæ”¾åˆ°ç‰ˆæœ¬æ§åˆ¶git repoæˆ–è€…å·¥ç¨‹ä»“åº“é‡Œé¢ï¼ŒåŒæ ·é€šè¿‡SCMå·¥å…·æˆ–è€…pipline scriptä¸‹è½½ä¸‹æ¥è„šæœ¬æ‰€åœ¨çš„å·¥ç¨‹ã€‚æ¥ä¸‹æ¥è®©jenkins jobè‡ªåŠ¨æ‰§è¡Œæ­¤è„šæœ¬ã€‚pipline stageå‘½åä¸ºâ€Buildâ€åµŒå…¥åˆ°ä¸Šä¸ªæ­¥éª¤çš„nodeé˜¶æ®µã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">stage</span><span class="o">(</span><span class="err">'</span><span class="nc">Preparation</span><span class="err">'</span><span class="o">)</span> <span class="o">{</span> 
   <span class="cm">/* download project source and build script source */</span>
<span class="o">}</span>
<span class="n">state</span><span class="o">(</span><span class="err">'</span><span class="nc">Build</span><span class="err">'</span><span class="o">){</span>
   <span class="cm">/* sh call build script*/</span>
   <span class="n">sh</span> <span class="err">'</span><span class="n">python</span> <span class="n">android_bundle_build</span><span class="o">.</span><span class="na">py</span>  <span class="n">æ„å»ºå‚æ•°</span> <span class="err">'</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å®é™…ä¸Šæ‰“åŒ…è¿˜æ˜¯éœ€è¦ä¸€äº›å‚æ•°ä¼ å…¥çš„ï¼Œå¦‚ä¸Šæ–‡project.extèŠ‚ç‚¹çš„groupIdã€versionName ã€artifactIdçš„ä¿¡æ¯ã€‚jenkinesè„šæœ¬æ”¯æŒå‚æ•°çš„ä¼ å…¥é…ç½®å¹¶ä¸”ç›´æ¥åœ¨è„šæœ¬ä¸­è·å–å˜é‡ã€‚</p>

<p>Project settingä¸­å‹¾é€‰This project is parameterizedé€‰é¡¹ï¼Œæ·»åŠ å¯¹åº”æ‰€éœ€ç±»å‹çš„å‚æ•°ï¼Œå¦‚ä¸‹ï¼š</p>

<p><img src="/assets/images/jekins_params.png" alt="index page" /></p>

<p>æ­¤æ—¶start jobæ—¶å€™ç‚¹å‡»Build with Parameterså°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¯å¡«å…¥å†…å®¹çš„ç½‘é¡µï¼Œå¡«å…¥ååˆjenkinsä¼ å…¥jobåˆšæ‰è®¾ç½®çš„å˜é‡ä¸­ï¼š</p>

<p><img src="/assets/images/jekins_params2.png" alt="index page" /></p>

<h3>å˜é‡çš„ä½¿ç”¨</h3>

<p>è·å–å˜é‡åä¼ å…¥åˆ°æ‰“åŒ…è„šæœ¬ï¼Œä¾›æ‰“åŒ…è„šæœ¬ä½¿ç”¨ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">sh</span> <span class="err">'</span><span class="n">python</span> <span class="n">android_bundle_build</span><span class="o">.</span><span class="na">py</span>  <span class="o">-</span><span class="n">groupId</span> <span class="n">$groupId</span> <span class="o">-</span><span class="n">artifactId</span> <span class="n">$artifactId</span> <span class="o">-</span><span class="n">version</span> <span class="n">$version</span><span class="err">'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><b>$å˜é‡å å³å¯è·å¾—é¡µé¢å¡«å†™çš„å˜é‡å€¼ï¼ˆgroovy è¯­æ³•ï¼‰ã€‚</b></p>

<h3>ç‰ˆæœ¬å‡çº§</h3>

<p>å®Œæˆäº†è‡ªåŠ¨å‘å¸ƒå’Œå‡çº§é™æ€åº“ï¼Œå®é™…ä¸Šå…¶ä»–çš„å¼€å‘çš„åŒå­¦è¿˜æ˜¯è·å–ä¸åˆ°æœ€æ–°çš„ä¾èµ–ç‰ˆæœ¬ã€‚
build.gradleä¸­çš„ä¾èµ–ç‰ˆæœ¬</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="cm">/* æ­¤å¤„çš„versionè¿˜æ˜¯æ²¡æœ‰å¾—åˆ°æ›´æ–°çš„*/</span>
<span class="n">compile</span> <span class="err">'</span><span class="n">com</span><span class="o">.</span><span class="na">test</span><span class="err">@</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">0</span><span class="nd">@aar</span><span class="err">'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><b>è§£å†³æ–¹æ¡ˆ</b></p>

<p>æå–gradleçš„ä¾èµ–åˆ°é…ç½®æ–‡ä»¶version_config.xml</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="err">'</span><span class="mf">1.0</span><span class="err">'</span> <span class="n">encoding</span><span class="o">=</span><span class="err">'</span><span class="n">utf8</span><span class="err">'</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="nc">Module</span><span class="o">-</span><span class="n">list</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nc">Module</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="nc">CommonModule</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">com</span><span class="o">.</span><span class="na">test</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">android</span><span class="o">-</span><span class="n">common</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">versionName</span><span class="o">&gt;</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">0</span><span class="o">&lt;/</span><span class="n">versionName</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nc">Module</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nc">Module</span><span class="o">-</span><span class="n">list</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>gradleè§£æversion.configã€‚è§£ææ–‡ä»¶ï¼šparse_version.gradle</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="n">def</span> <span class="nf">parseXml</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">def</span> <span class="n">modules</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlParser</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">rootDir</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/config/version_config.xml"</span><span class="o">);</span>
  <span class="n">modules</span><span class="o">.</span><span class="na">Module</span><span class="o">.</span><span class="na">each</span> <span class="o">{</span>
  <span class="n">def</span> <span class="n">moduleName</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">text</span><span class="o">();</span>
  <span class="n">def</span> <span class="n">moduleGroupId</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">groupId</span><span class="o">.</span><span class="na">text</span><span class="o">();</span>
  <span class="n">def</span> <span class="n">moduleArtifactId</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">artifactId</span><span class="o">.</span><span class="na">text</span><span class="o">();</span>
  <span class="n">def</span> <span class="n">moduleVersionName</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">versionName</span><span class="o">.</span><span class="na">text</span><span class="o">();</span>

  <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">StringBuffer</span> <span class="n">str</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">();</span>
       <span class="n">str</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">moduleGroupId</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">":"</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">moduleArtifactId</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">":"</span><span class="o">)</span>
                                       <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">moduleVersionName</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"@aar"</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="n">reference</span> <span class="n">in</span> <span class="n">rootProject</span><span class="o">.</span><span class="na">ext</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">reference</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">moduleName</span><span class="o">,</span> <span class="n">str</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="k">break</span><span class="o">;</span>
       <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æœ€å¤–å±‚build.gradleä¸­apply parse_version.gradleï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>apply from: rootDir.getAbsolutePath() + "/script/parse_version.gradle"
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­¤æ—¶çš„ä¾èµ–æ–¹å¼æ›´æ”¹ä¸ºï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="cm">/* æ­¤å¤„çš„versionä»version_configä¸­è·å– */</span>
<span class="n">compile</span> <span class="n">rootProject</span><span class="o">.</span><span class="na">CommonModule</span> 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>CommonModuleå³ä¸ºversion_config.xmlä¸­å®šä¹‰çš„nameèŠ‚ç‚¹ã€‚</p>

<p>åˆ°è¿™é‡Œåªå·®ä¸€æ­¥ï¼Œé‚£å°±æ˜¯<b>jenkinsæ‰“åŒ…ä¸Šä¼ ä¹‹åè‡ªåŠ¨å‡çº§version_configä¸­çš„versionName</b>ã€‚</p>

<p>ä¸ºäº†è®©å¤§å®¶éƒ½èƒ½å¾—åˆ°æ›´æ–°ï¼Œå¯ä»¥åœ¨jobå®Œæˆçš„æ—¶å€™é€šè¿‡git apiç›´æ¥ä¿®æ”¹å¹¶æäº¤version_configä¸­çš„versionNameã€‚</p>

<p>åŒæ ·å¯ä»¥ä½¿ç”¨pythonæ¥å®Œæˆã€‚pythonæœ‰æˆç†Ÿçš„git/gitlab/svnå·¥å…·åŒ…ã€‚è¿™é‡Œæ¨èå‡ ä¸ªï¼š</p>

<p><a href="http://link.zhihu.com/?target=https%3A//github.com/python-gitlab/python-gitlab">python-gitlab/python-gitlab</a></p>

<p><a href="http://link.zhihu.com/?target=http%3A//gitpython.readthedocs.io/en/stable/tutorial.html">GitPython Tutorial</a></p>

<p>å¯¹åº”å…·ä½“çš„git/gitlab ä¿®æ”¹æ–‡ä»¶api</p>

<p>å¦‚gitlab v3 apiï¼š</p>

<p><img src="/assets/images/gitlab_api.png" alt="index page" /></p>

<p>å®Œæˆmodify_version_config.pyçš„åŠŸèƒ½ä¹‹åï¼ŒåŒç†å»stateèŠ‚ç‚¹å»æ‰§è¡Œè‡ªåŠ¨çš„ä»»åŠ¡ã€‚</p>

<p>è‡³æ­¤ã€‚è‡ªåŠ¨æ‰“åŒ…å‡çº§çš„åŠŸèƒ½å°±å®Œæˆäº†ï¼Œjenkinesæœ‰ç®€æ˜“çš„æ“ä½œç•Œé¢ã€‚å¯ä»¥å»å¯è§†åŒ–çš„ä¸€é”®æ‰“åŒ…å•¦ï¼š</p>

<p><img src="/assets/images/jekins_piple_view.png" alt="index page" /></p>

<p>è¿›å…¥å¯¹åº”jobè§†å›¾ï¼Œç‚¹å‡» Build With ParameteræŒ‰é’®ï¼Œå¡«å…¥å¿…é¡»å‚æ•°ã€‚å¯åŠ¨ï¼</p>

<p>ä¼¼ä¹è›®ç®€é™‹çš„ã€‚è‡ªå·±æˆ–è€…å°è§„æ¨¡å›¢é˜Ÿç”¨ç”¨è¿˜å¯ä»¥ã€‚åšæ›´å¥½çš„äº§å“ï¼Œè¿˜æ˜¯éœ€è¦æ›´è¿›ä¸€æ­¥çš„å®Œæˆ.</p>
:ET