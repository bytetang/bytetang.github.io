I"±²<h2 id="ç©ºæŒ‡é’ˆç¯‡">ç©ºæŒ‡é’ˆç¯‡</h2>

<ol>
  <li>ã€å»ºè®®ã€‘å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œå°†å¸¸é‡æ”¾åœ¨å‰é¢</li>
</ol>

<p>case:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DOMESTIC</span> <span class="o">=</span> <span class="s">"1"</span>
<span class="n">domestic</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="no">DOMESTIC</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¿®æ­£ä¸ºï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="no">DOMESTIC</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">domestic</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>é¡µé¢é—´å¯¹è±¡ä¼ å‚åœ¨æ•°æ®ä¸å®Œæ•´çš„æƒ…å†µä¸‹å´©æºƒï¼Œå¤šæ•°æƒ…å†µä¸‹æ˜¯å› ä¸ºæ¥æ”¶åˆ°äº†ç©ºçš„ä¼ å‚æœªå¤„ç†ç›´æ¥è°ƒç”¨ï¼Œå»ºè®®ä¸è¦ä¾èµ–è°ƒç”¨æ–¹çš„â€å®‰å…¨â€ä½¿ç”¨ã€‚</p>
</blockquote>

<ol>
  <li>è¿”å›ç©ºåˆ—è¡¨æ›¿ä»£null</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="nf">getAllLocale</span><span class="o">(){</span>
     <span class="o">...</span>
      <span class="k">if</span><span class="o">(</span><span class="n">productList</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;();</span>
      <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>returnå‚æ•°åœ¨åç»­ä¼šè¢«ä½¿ç”¨ï¼Œå¦‚æœéš¾ä»¥ä¿è¯è°ƒç”¨çš„åœ°æ–¹éƒ½å®‰å…¨çš„è°ƒç”¨äº†ï¼Œæœ€å¥½è¿˜æ˜¯ä¸è¦è¿”å›nullã€‚</p>
</blockquote>

<ol>
  <li>ã€å»ºè®®ã€‘ä½¿ç”¨åˆ¤ç©ºçš„å·¥å…·ç±»</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">//å­—ç¬¦æ¢åˆ¤ç©º</span>
<span class="n">android</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span>
 
<span class="c1">//é›†åˆåˆ¤ç©º</span>
<span class="nc">CustomListUtil</span><span class="o">.</span><span class="na">hasItem</span><span class="o">()|</span><span class="n">isNullOrEmpty</span><span class="o">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>ä½¿ç”¨å·¥å…·ç±»çš„å¥½å¤„æ˜¯ï¼Œå®¹æ˜“å…»æˆä¹ æƒ¯å¹¶ä¸”é¿å…å–åç­‰é€»è¾‘é”™å†™å‡ºç°</p>
</blockquote>

<ol>
  <li>ã€é‡è¦ã€‘ä½¿ç”¨String.valueOf(Object) æ›¿ä»£ Object.toString()</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">..;</span>
 
<span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"TAG"</span><span class="o">,</span><span class="n">user</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ›´æ”¹ä¸ºï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nc">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"TAG"</span><span class="o">,</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">user</span><span class="o">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>ä½ çš„Deeplink/Router/CMPCæ¯ä¸ªå‚æ•°éƒ½åº”è¯¥è€ƒè™‘ç©ºçš„æƒ…å†µ</li>
</ol>

<p>å¥‘çº¦ç±»å‹ï¼Œä¼ å…¥çš„å‚æ•°è¾ƒä¸ºè‡ªç”±ï¼Œç»„åˆä¹Ÿæ¯”è¾ƒå¤šã€‚å³ä½¿è§„èŒƒå¥½äº†è°ƒç”¨æ–¹å¼ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨éæ³•çš„ä¼ å…¥ã€‚è¯·è€ƒè™‘æ¯ä¸ªå‚æ•°ä¸ºç©ºçš„æƒ…å†µã€‚</p>

<ol>
  <li>ä½¿ç”¨contextå’Œactivityçš„å¼•ç”¨æ—¶å…ˆåˆ¤ç©º</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nc">Router</span><span class="o">.</span><span class="na">toLogin</span><span class="o">((</span><span class="nc">Activity</span><span class="o">)</span> <span class="n">view</span><span class="o">,</span>
    <span class="k">new</span> <span class="nf">IRouterCallBack</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResult</span><span class="o">(</span><span class="nc">String</span> <span class="n">module</span><span class="o">,</span> <span class="nc">String</span> <span class="n">page</span><span class="o">,</span> <span class="nc">Bundle</span> <span class="n">bundle</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isLogin</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">setTitle</span><span class="o">(</span><span class="s">"test"</span><span class="o">)</span>
     <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>onResultå›è°ƒæ—¶ï¼Œviewå¯èƒ½å·²ç»è¢«å›æ”¶äº†ã€‚</p>

<blockquote>
  <p>activityè¢«å›æ”¶åè°ƒç”¨å®¹æ˜“å¼•èµ·å†…å­˜æ³„æ¼ï¼Œç›¸å¯¹äºæ‰¾å†…å­˜æ³„æ¼ï¼Œç©ºå®‰å…¨ä¹Ÿå¯èƒ½è®©å†…å­˜æ³„æ¼ä¸Crashã€‚</p>
</blockquote>

<h2 id="ç±»å‹è½¬æ¢ç¯‡">ç±»å‹è½¬æ¢ç¯‡</h2>

<ol>
  <li>ã€å»ºè®®ã€‘æ³¨æ„ä½ çš„Stringè½¬Numberçš„æ–¹æ³•</li>
</ol>

<p>å¦‚ï¼šDouble.valueOf(String),String.parseDouble(String) ï¼Œä¼ å…¥çš„ç±»å‹å¦‚æœä¸æ˜¯æ•°å­—æ ¼å¼çš„å°±ä¼šå‡ºé”™ã€‚åšå¥½åˆæ³•æ€§æ ¡éªŒï¼Œç”šè‡³æ˜¯trycatchã€‚</p>

<p>æ­£ç¡®å¦‚ä¸‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="o">(</span><span class="n">gatewayTime</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="k">try</span> <span class="o">{</span>
		<span class="kt">double</span> <span class="n">gatewayTimeDouble</span> <span class="o">=</span> <span class="nc">Double</span><span class="o">.</span><span class="na">parseDouble</span><span class="o">(</span><span class="n">gatewayTime</span><span class="o">);</span>
		<span class="n">serverCallParams</span><span class="o">.</span><span class="na">addCurrentServerCallExtraInfos</span><span class="o">(</span><span class="s">"gatewayTime"</span><span class="o">,</span> <span class="n">gatewayTimeDouble</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>ã€é‡è¦ã€‘ä¸è¦ä¿¡ä»»ç³»ç»ŸAPIè¿”å›çš„æ•°æ®ã€‚è½¬æ¢æ“ä½œä¸€å¾‹trycatch.trycatch.</li>
</ol>

<p>é”™è¯¯ç¤ºä¾‹:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">//è·å–ç½‘ç»œä»£ç†çš„çŠ¶æ€</span>
<span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"http.proxyPort"</span><span class="o">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¿™é‡Œè¿”å›çš„ä¸ä¸€å®šæ˜¯æ•°å­—ï¼Œå¯èƒ½çš„åŸå› æ˜¯å®‰å“ç¢ç‰‡å¤ªä¸¥é‡ï¼Œæœ‰äº›å‚å•†ä¸Šçš„apiå°±è¯´ä¸å®šäº†ã€‚</p>

<ol>
  <li>ã€é‡è¦ã€‘åšå¥½ç±»å‹åˆ¤æ–­åå†è½¬æ¢</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="o">(</span><span class="n">params</span> <span class="k">instanceof</span> <span class="nc">CoordinatorLayout</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">((</span><span class="nc">CoordinatorLayout</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">)</span> <span class="n">params</span><span class="o">).</span><span class="na">setBehavior</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>kotlinçš„è¯ä½¿ç”¨iså…³é”®å­—</p>
</blockquote>

<h2 id="çº¿ç¨‹å®‰å…¨ç¯‡">çº¿ç¨‹å®‰å…¨ç¯‡</h2>

<p>1.ã€é‡è¦ã€‘ä½ çš„å•ä¾‹å®‰å…¨å—</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nc">DBHelper</span> <span class="n">instance</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
 
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">DBHelper</span> <span class="nf">getDBHelper</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DBHelper</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹dbHelper == nullå°±ä¸æ˜¯ä¸€å®šæˆç«‹çš„äº†ï¼Œè¿™å°±å¯èƒ½å¯¼è‡´åˆ›å»ºäº†å¤šä¸ªå®ä¾‹å‡ºæ¥ï¼Œè¿èƒŒäº†å•ä¾‹çš„æœ¬æ„ã€‚</p>

<blockquote>
  <p>è¿™é‡Œå¯ä»¥voliate ä½ çš„dbHelperï¼Œè®©è¿™ä¸ªå˜é‡å¯¹å…¶ä»–çš„çº¿ç¨‹å¯è§ã€‚æˆ–è€…åŒæ­¥æ•´ä¸ªè·å–å•ä¾‹çš„æ“ä½œï¼Œä½†æ˜¯åœ¨é¢‘ç¹è°ƒç”¨çš„æƒ…å†µä¸‹æ³¨æ„æ€§èƒ½å¼€é”€ã€‚</p>
</blockquote>

<p>çº¿ç¨‹å®‰å…¨å•ä¾‹ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">IBULocaleManager</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">IBULocaleManager</span> <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mutex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IBULocaleManager</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æˆ–</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">IBULocaleManager</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IBULocaleManager</span><span class="o">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>åœ¨getInstance()æ¯”è¾ƒé¢‘ç¹æƒ…å†µä¸‹ï¼Œå¤šæ•°æ˜¯å‘½ä¸­éç©ºç›´æ¥å®ä¾‹çš„ï¼Œ å¦‚æœå¯¹æ•´ä¸ªgetInstanceæ–¹æ³•åŠ é”å°±ä¼šå½±å“æ€§èƒ½ï¼Œè¿™é‡Œåªåœ¨ä¸ºç©ºéœ€è¦åˆå§‹åŒ–å¯¹è±¡çš„æ—¶å€™åŒæ­¥å’Œæ ¡éªŒï¼Œå¤§å¤§é™ä½äº†å¯¹æ€§èƒ½çš„å½±å“ã€‚</p>
</blockquote>

<ol>
  <li>ã€å»ºè®®ã€‘éšè—ä½ å¯ä»¥ç§æœ‰çš„æ–¹æ³•å’Œå˜é‡</li>
</ol>

<p>å¦‚æœä½ çš„æ–¹æ³•ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æ–¹æ³•ï¼Œä¸”éƒ½æ˜¯å†…éƒ¨è‡ªå·±åœ¨è°ƒç”¨ï¼ˆJavaé‡Œé¢æŒ‡åœ¨åŒä¸€ä¸ªç±»ï¼‰ï¼Œè¯·ç›´æ¥ç§æœ‰æ‰æ–¹æ³•/å˜é‡ï¼Œé¿å…æš´éœ²å‡ºå»è®©è°ƒç”¨æ–¹å¼•å…¥äº†å´©æºƒã€‚</p>

<ol>
  <li>ã€é‡è¦ã€‘å‘ç°æ­»é”</li>
</ol>

<ul>
  <li>å½“å¿ƒåµŒå¥—é”ï¼Œ</li>
</ul>

<p>å¦‚ä¸‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="n">lock1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="n">lock2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
 
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock1</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock2</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">lock1</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>è·å–é”è®¾ç½®è¶…æ—¶</li>
</ul>

<p>å¤šæ•°æƒ…å†µä¸‹ReentrantLockå¯ä»¥æ›¿æ¢synchronizedï¼Œè·å–é”æ—¶è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œé™ä½æ­»é”é£é™©ã€‚</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock1</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span> <span class="o">{}</span>
    <span class="o">}</span>
 <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>æ­£ç¡®é‡Šæ”¾é”
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">try</span><span class="o">{</span>
  <span class="k">do</span><span class="o">...</span>
<span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">){</span>
  <span class="c1">//lock.unlock() ä¸è¦åœ¨è¿™é‡Œé‡Šæ”¾é”ï¼Œtry blocké‡Œé¢å¯èƒ½ä¹Ÿæ²¡æœ‰é‡Šæ”¾ï¼Œè€Œè¿™é‡Œåªå¤„ç†å¼‚å¸¸çš„åœºæ™¯</span>
<span class="o">}</span><span class="k">finally</span><span class="o">{</span>
  <span class="c1">//è¿™é‡Œé‡Šæ”¾é”æœ€ä½³</span>
  <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">()</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<p>4.ã€é‡è¦ã€‘é›†åˆéå†è¦å½“å¿ƒ</p>

<p>å¦‚æœä½ æ²¡æœ‰é€‰æ‹©çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»ï¼ˆå¦‚CopyOnWriteArrayList)ï¼Œé‚£é›†åˆæ“ä½œçš„åœ°æ–¹éƒ½è¦å½“å¿ƒäº†ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="o">...</span>
<span class="kd">class</span> <span class="nc">RunableA</span> <span class="kd">implements</span> <span class="nc">Runable</span><span class="o">{</span>
    <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
        <span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">next</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">RunableB</span> <span class="kd">implements</span> <span class="nc">Runable</span><span class="o">{</span>
    <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">String</span> <span class="nl">str:</span><span class="n">list</span><span class="o">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
            <span class="o">...</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­£ç¡®å†™æ³•,æ“ä½œé›†åˆçš„æ—¶å€™åŠ åŒæ­¥ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>
<span class="kd">synchronized</span><span class="o">(</span><span class="n">list</span><span class="o">){</span>
    <span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">next</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">synchronized</span><span class="o">(</span><span class="n">list</span><span class="o">){</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">String</span> <span class="nl">str:</span><span class="n">list</span><span class="o">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>ä¸ºäº†ä¿è¯é”çš„æ­£ç¡®æ€§å’Œä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ï¼Œæœ€å¥½<b>é›†åˆå¯¹è±¡æ¥ä½œä¸ºå¯¹è±¡é”</b>ï¼Œé¿å…ä½¿ç”¨thisè¿™ç§å¯¹è±¡é”ï¼ŒåŒ¿åå†…éƒ¨ç±»çš„è¯é”çš„å°±å¯èƒ½ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡äº†ï¼Œé”ä¹Ÿæ˜¯æ— æ•ˆçš„ã€‚</p>
</blockquote>

<ol>
  <li>ã€é‡è¦ã€‘çº¿ç¨‹çš„å–æ¶ˆå’Œå…³é—­</li>
</ol>

<p>è¿™æ˜¯ä¸ªå®¹æ˜“è¢«å¿½è§†ä½†æ˜¯å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œå¦‚æœä½ çš„çº¿ç¨‹ä¸èƒ½å“åº”é”™è¯¯çš„ä¸­æ–­æˆ–è€…åœ¨ä»»åŠ¡ç»“æŸçš„æ—¶å€™æ²¡æœ‰æ­£ç¡®çš„å…³é—­å®ƒï¼Œé‚£ä¹ˆä»–ä»¬ä¸€ç›´è¿è½¬ä¸‹å»ï¼Œèµ„æºå¼€é”€ç­‰ä¹Ÿä¸€ç›´å­˜åœ¨ï¼Œé—´æ¥å¼•å‘å…¶ä»–é—®é¢˜ã€‚</p>

<ul>
  <li>ExecuteService shutdown()</li>
</ul>

<p>æ­£ç¡®çš„stop</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>  
    <span class="k">try</span> <span class="o">{</span>  
        <span class="n">exec</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span> 
        <span class="n">exec</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="no">TIMEOUT</span><span class="o">,</span> <span class="no">UNIT</span><span class="o">);</span>  
    <span class="o">}</span>  
<span class="o">}</span>  
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>éœ€è¦åŒºåˆ†shudown()å’ŒshutdownNow()çš„åŒºåˆ«ï¼Œå¦‚æœä½ å·²ç»submitçš„taskè¿˜æƒ³ç»§ç»­å¾—åˆ°æ‰§è¡Œè¯·ä¸è¦ä½¿ç”¨å’ŒshutdownNowã€‚</p>
</blockquote>

<ul>
  <li>â€œæ¯’ä¸¸â€/â€æ ‡å¿—ä½â€ä¸­æ–­</li>
</ul>

<p>æŠ•æ”¾â€æ¯’ä¸¸â€</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">canceled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é‡åˆ°æ¯’ä¸¸æ”¾å¼ƒ</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">while</span><span class="o">(!</span><span class="n">canceled</span><span class="o">){</span>
    <span class="n">doTask</span><span class="o">()</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>Future cancle</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nc">Future</span> <span class="n">future</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">());</span>
<span class="k">try</span> <span class="o">{</span>
   <span class="c1">// å¯èƒ½æŠ›å‡ºå¼‚å¸¸</span>
   <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
    <span class="c1">//ç»ˆæ­¢ä»»åŠ¡çš„æ‰§è¡Œ</span>
    <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="androidå…¶ä»–ç¯‡">Androidå…¶ä»–ç¯‡</h2>

<p>1ã€æ•°æ®åº“çš„æ“ä½œ</p>

<ul>
  <li>ç¡®ä¿æ“ä½œçš„helperç±»æ˜¯å•ä¾‹çš„å¹¶è€ƒè™‘äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</li>
  <li>æŸ¥è¯¢çš„æ—¶å€™å°½é‡ä½¿ç”¨ç´¢å¼•</li>
  <li>é¿å…DBè¿‡å¤§ï¼Œä¼šå¼•å…¥è¾ƒå¤šçš„ç³»ç»Ÿæ€§é—®é¢˜</li>
</ul>

<p><br /></p>
<ol>
  <li>ã€é‡è¦ã€‘æ··æ·†ç±»é—®é¢˜</li>
</ol>

<ul>
  <li>æ¥å…¥ç¬¬ä¸‰æ–¹åº“æˆ–è€…åº•å±‚åº“çš„æ—¶å€™è¦é˜…è¯»å’Œå…³æ³¨æ··æ·†è§„åˆ™çš„æ¥å…¥</li>
  <li>åå°„è°ƒç”¨çš„ç±»/æ–¹æ³•æ£€æŸ¥ä¸èƒ½æ··æ·†ï¼Œå¼•å‘å¯¼è‡´classnotfound</li>
</ul>

<p><br /></p>
<ol>
  <li>ã€å»ºè®®ã€‘æ³¨æ„å­—ç¬¦ä¸²æ‹¼æ¥æ€§èƒ½</li>
</ol>

<p>é¿å…å¤§é‡å­—ç¬¦ä¸²â€+â€çš„æ“ä½œ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"start"</span><span class="o">;</span>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span> <span class="o">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
    <span class="n">str</span> <span class="o">=</span> <span class="n">str</span> <span class="o">+</span> <span class="s">"trip"</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>å»ºè®®ä½¿ç”¨StringBuiler/StringBufferç­‰å®Œæˆ</p>
</blockquote>

<ol>
  <li>ã€å»ºè®®ã€‘æ³¨æ„å­—ç¬¦ä¸²åˆ†éš”æ€§èƒ½</li>
</ol>

<p>é¿å…åœ¨ä¼šè¢«é¢‘ç¹è°ƒç”¨çš„æ–¹æ³•ä¸­ä½¿ç”¨ä»¥ä¸‹æ–¹å¼åˆ†éš”å­—ç¬¦ä¸²</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"hello-world"</span><span class="o">;</span>
<span class="nc">String</span><span class="o">[]</span> <span class="n">results</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"-"</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è¯·ä½¿ç”¨æ€§èƒ½æ›´å¥½çš„<code class="language-plaintext highlighter-rouge">indexOf()+substring(from+1, to)</code>ç»„åˆ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"hello-world"</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">from</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">'-'</span><span class="o">);</span>
<span class="kt">int</span> <span class="n">to</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="sc">'-'</span><span class="o">,</span> <span class="n">from</span><span class="o">+</span><span class="mi">1</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">brown</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">from</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">to</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>ã€é‡è¦ã€‘åˆ«åœ¨å†™å†…å­˜æ³„æ¼äº†ï¼</li>
</ol>

<p><b>HandlerLeak</b></p>

<p>åŸå› ï¼šHandleråœ¨Androidä¸­ç”¨äºæ¶ˆæ¯çš„å‘é€ä¸å¼‚æ­¥å¤„ç†ï¼ˆMessageQueue)ï¼Œå¸¸å¸¸åœ¨Activityä¸­ä½œä¸ºä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»æ¥å®šä¹‰ï¼Œæ­¤æ—¶Handlerä¼šéšå¼åœ°æŒæœ‰ä¸€ä¸ªå¤–éƒ¨ç±»å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªActivityï¼‰çš„å¼•ç”¨ã€‚å½“Activityå·²ç»è¢«ç”¨æˆ·å…³é—­æ—¶ï¼Œå†…éƒ¨çš„Handlerè¿˜è¢«MessageQueueä¿ç•™ç€ï¼ŒHandleræŒæœ‰çš„Activityå¼•ç”¨é€ æˆActivityæ— æ³•è¢«GCå›æ”¶ï¼Œè¿™æ ·å®¹æ˜“é€ æˆå†…å­˜æ³„éœ²ã€‚</p>

<p>æ­£ç¡®çš„åšæ³•æ˜¯å°†å…¶å®šä¹‰æˆä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼ˆæ­¤æ—¶ä¸ä¼šæŒæœ‰å¤–éƒ¨ç±»å¯¹è±¡çš„å¼•ç”¨ï¼‰ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­ä¼ å…¥Activityå¹¶å¯¹Activityå¯¹è±¡å¢åŠ ä¸€ä¸ªå¼±å¼•ç”¨ï¼Œè¿™æ ·Activityè¢«ç”¨æˆ·å…³é—­ä¹‹åï¼Œå³ä¾¿å¼‚æ­¥æ¶ˆæ¯è¿˜æœªå¤„ç†å®Œæ¯•ï¼ŒActivityä¹Ÿèƒ½å¤Ÿè¢«GCå›æ”¶ï¼Œä»è€Œé¿å…äº†å†…å­˜æ³„éœ²ã€‚</p>

<p>é£é™©ä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span><span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Handler</span> <span class="n">mHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Handler</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">};</span>
    <span class="o">};</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ­£ç¡®æ¡ˆä¾‹:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyHandler</span> <span class="kd">extends</span> <span class="nc">Handler</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">Activity</span><span class="o">&gt;</span> <span class="n">reference</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">MyHandler</span><span class="o">(</span><span class="nc">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">Activity</span><span class="o">&gt;(</span><span class="n">activity</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">reference</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
            <span class="c1">// do something...</span>
            <span class="k">break</span><span class="o">;</span>
            <span class="k">default</span><span class="o">:</span>
            <span class="c1">// do something...</span>
            <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><b>StaticFieldLeak</b>
åŸå› ï¼šé™æ€å¯¹è±¡/å˜é‡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä»ç¬¬ä¸€æ¬¡è¢«JVMåŠ è½½åˆ°å†…å­˜ä¸€ç›´åˆ°ç¨‹åºé€€å‡ºï¼Œå…¶ä½™çš„æ—¶é—´ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶éƒ½ä¸ä¼šå»å›æ”¶å®ƒã€‚</p>

<p>é”™è¯¯æ¡ˆä¾‹ï¼šå•ä¾‹ä¸­ä¼ å…¥context/activityã€‚å¯¼è‡´context/acitivityæ²¡æœ‰åŠæ³•åŠæ—¶å›æ”¶ã€å¼•èµ·å†…å­˜æ³„æ¼</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MapNavigationUtil</span> <span class="o">{</span>
       <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Context</span> <span class="n">mContext</span><span class="o">;</span>
       <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MapNavigationUtil</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapNavigationUtil</span><span class="o">();</span>
       <span class="kd">private</span> <span class="nf">MapNavigationUtil</span><span class="o">()</span> <span class="o">{}</span>
       <span class="kd">public</span> <span class="kd">static</span> <span class="nc">MapNavigationUtil</span> <span class="nf">getInstance</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
        <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ­£ç¡®å†™æ³•:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MapNavigationUtil</span> <span class="o">{</span>
       <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Context</span> <span class="n">mContext</span><span class="o">;</span>
       <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MapNavigationUtil</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MapNavigationUtil</span><span class="o">();</span>
       <span class="kd">private</span> <span class="nf">MapNavigationUtil</span><span class="o">()</span> <span class="o">{}</span>
       <span class="kd">public</span> <span class="kd">static</span> <span class="nc">MapNavigationUtil</span> <span class="nf">getInstance</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">();</span> <span class="c1">//ä½¿ç”¨applicationContext</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
        <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<ol>
  <li>ã€é‡è¦ã€‘æ­£ç¡®ä½¿ç”¨@TargetApiæ³¨è§£
è¿™ä¸ªä»…ç”¨äºé«˜ç‰ˆæœ¬ç¼–è¯‘å…¼å®¹ï¼Œä¸ä»£è¡¨åªä¼šè¢«é«˜ç‰ˆæœ¬è°ƒç”¨ã€‚</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nd">@TargetApi</span><span class="o">(</span><span class="nc">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">LOLLIPOP</span><span class="o">)</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setupToolbar</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">mRlToolbar</span><span class="o">.</span><span class="na">setElevation</span><span class="o">(</span><span class="nc">ViewUtil</span><span class="o">.</span><span class="na">dp2px</span><span class="o">(</span><span class="n">getContext</span><span class="o">(),</span> <span class="mi">2</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä½äºLOLLIPOPç‰ˆæœ¬çš„ä¹Ÿä¼šè°ƒç”¨æ¬¡æ–¹æ³•å‡ºç°å´©æºƒçš„æƒ…å†µï¼Œå¦‚æœæ˜¯ä¸ºäº†åŒºåˆ†ä¸åŒç‰ˆæœ¬çš„è°ƒç”¨ï¼Œä½¿ç”¨Buildå˜é‡åšåˆ¤æ–­ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="o">(</span><span class="nc">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">LOLLIPOP</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">setupToolbar</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>ã€é‡è¦ã€‘é¿å…show dialog å‡ºç°BadTokenException</li>
</ol>

<p>æ­£ç¡®showçš„æ–¹å¼:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">if</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isFinishing</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">alert</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Toast/DialogFragment/AlertDialog/Dialogçš„ä½¿ç”¨å‡è¦æ³¨æ„ã€‚</p>

<blockquote>
  <p>åŸå› æ˜¯activityå¯èƒ½å·²ç»è¢«é”€æ¯äº†ï¼Œä¸Šä¸‹æ–‡contextä¹Ÿéšä¹‹è¢«é”€æ¯ï¼Œè¿™ä¸ªæ—¶å€™å†è¯•å›¾å»showï¼Œå°±ä¼šå‡ºç°Crash.</p>
</blockquote>

<ol>
  <li>ã€é‡è¦ã€‘å¼‚æ­¥show DialogFragment ä½¿ç”¨ commitAllowingStateLossä»£æ›¿show/commitæ–¹æ³•</li>
</ol>

<p>android ä¸å…è®¸åœ¨activityçš„onSaveInstanceStateè°ƒç”¨ä¹‹åå†æ”¹å˜çŠ¶æ€ï¼Œæ¯”å¦‚æ·»åŠ æˆ–ç§»é™¤fragmentã€‚å¦‚æœç³»ç»Ÿåœ¨å¯èƒ½å›æ”¶äº†activityä¹‹åä»ç„¶æœ‰å¼‚æ­¥çš„commitç­‰æ“ä½œï¼Œå°±ä¼šå‡ºç°state lossçš„crash.</p>

<p>è§£å†³æ–¹æ¡ˆï¼š</p>

<p>ä½¿ç”¨commitAllowingStateLoss()ä»£æ›¿FragmentTransaction commitæˆ–showæ–¹æ³•ã€‚</p>

<p>æ­£ç¡®ç¤ºä¾‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">showDialog</span><span class="o">(</span><span class="nc">FragmentActivity</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
<span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">context</span><span class="o">.</span><span class="na">isFinishing</span><span class="o">())</span> <span class="o">{</span>
       <span class="nc">FragmentTransaction</span> <span class="n">ft</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getSupportFragmentManager</span><span class="o">().</span><span class="na">beginTransaction</span><span class="o">();</span>
       <span class="n">ft</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="s">"PushAccessAuthDialog"</span><span class="o">);</span>
       <span class="n">ft</span><span class="o">.</span><span class="na">commitAllowingStateLoss</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li>ã€é‡è¦ã€‘Fragment commit vs commitAllowingStateLoss</li>
</ol>

<p>æ·» åŠ  Fragment æ—¶ï¼Œç¡®ä¿ FragmentTransaction#commit() åœ¨Activity#onPostResume()æˆ–è€… FragmentActivity#onResumeFragments()å†…è°ƒç”¨ã€‚
ä¸è¦éšæ„ä½¿ç”¨ FragmentTransaction#commitAllowingStateLoss()æ¥ä»£æ›¿ï¼Œä»»ä½•commitAllowingStateLoss()çš„ä½¿ç”¨å¿…é¡»ç»è¿‡ code reviewï¼Œç¡®ä¿æ— è´Ÿé¢å½±å“ã€‚</p>

<p><img src="/assets/images/activity_lifecycle.png" alt="index page" /></p>
:ET